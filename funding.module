<?php

/**
 * @file
 * Provide a field to store and display crowdfunding links and widgets.
 */

use Drupal\Component\Serialization\YamlSymfony;

/**
 * Implements hook_theme().
 */
function funding_theme($existing, $type, $theme, $path) {
  return [
    'funding_example' => [
      'variables' => [
        'provider' => NULL,
        'content' => NULL,
        'index' => 0,
      ],
    ],
    'funding_examples_container' => [
      'variables' => [
        'providers' => [],
        'examples' => [],
      ],
    ],
    'funding_link' => [
      'variables' => [
        'provider' => NULL,
        'url' => NULL,
        'content' => NULL,
      ],
    ],
  ];
}

/**
 * Implements template_preprocess_hook().
 */
function template_preprocess_funding_example(&$variables) {
  $variables['#attached']['library'][] = 'funding/examples-form';

  // The ending linebreak fixes issues with copying & pasting from single-line
  // examples.
  $variables['content'] .=  "\n";
  if (str_contains($variables['content'], "\n")) {
    $variables['content'] = YamlSymfony::encode(YamlSymfony::decode($variables['content']));
  }
}

/**
 * Implements template_preprocess_hook().
 */
function template_preprocess_funding_examples_container(&$variables) {
  // If not showing examples for specific providers, show all examples.
  if (!$variables['providers']) {
    /** @var \Drupal\funding\Service\FundingProviderPluginManager $plugin_manager */
    $plugin_manager = \Drupal::service('plugin.manager.funding_provider');
    $variables['providers'] = $plugin_manager->getFundingProviders();
  }

  $variables['#attached']['library'][] = 'funding/examples-form';
  $variables['examples'] = [];

  foreach ($variables['providers'] as $provider) {
    foreach ($provider->examples() as $index => $example_content) {
      $variables['examples'][$provider->id() . '_' . $index] = [
        '#theme' => 'funding_example',
        '#provider' => $provider->id(),
        '#content' => $example_content,
        '#index' => $index,
      ];
    }
  }
}

/**
 * Implements template_preprocess_hook().
 */
function template_preprocess_funding_link(&$variables) {
  $variables['attributes'] = [
    'href' => $variables['url'],
  ];
}
